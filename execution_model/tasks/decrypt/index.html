<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.91.2">
<meta name=description content>
<link rel=icon href=/zcash-sync/images/favicon.png type=image/png>
<title>Decrypt :: Zcash Warp Sync</title>
<link href=/zcash-sync/css/nucleus.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/fontawesome-all.min.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/hybrid.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/featherlight.min.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/perfect-scrollbar.min.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/auto-complete.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/atom-one-dark-reasonable.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/theme.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/tabs.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/hugo-theme.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/css/theme-blue.css?1665316482 rel=stylesheet>
<link href=/zcash-sync/common.css?1665316482 rel=stylesheet>
<script src=/zcash-sync/js/jquery-3.3.1.min.js?1665316482></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity=sha384-ZPe7yZ91iWxYumsBEOn7ieg8q/o+qh/hQpSaPow8T6BwALcXSCS6C6fSRPIAnTQs crossorigin=anonymous>
</head>
<body data-url=/zcash-sync/execution_model/tasks/decrypt/>
<nav id=sidebar class=showVisitedLinks>
<div id=header-wrapper>
<div id=header>
<a id=logo href=https://hhanh00.github.io/zcash-sync/>
<img srcset="https://hhanh00.github.io/zcash-sync//logo.png 4x">
</a>
</div>
<div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div>
<script type=text/javascript src=/zcash-sync/js/lunr.min.js?1665316482></script>
<script type=text/javascript src=/zcash-sync/js/auto-complete.js?1665316482></script>
<script type=text/javascript>var baseurl="https://hhanh00.github.io/zcash-sync/"</script>
<script type=text/javascript src=/zcash-sync/js/search.js?1665316482></script>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=/zcash-sync/light_wallet/ title="Light Wallets" class=dd-item>
<a href=/zcash-sync/light_wallet/><svg class="icon"><use xlink:href="https://hhanh00.github.io/zcash-sync//sprite.svg#wallet"/></svg>
Light Wallets
<i class="fas fa-check read-icon"></i>
</a>
<ul>
<li data-nav-id=/zcash-sync/light_wallet/purpose/ title=Purpose class=dd-item>
<a href=/zcash-sync/light_wallet/purpose/>
Purpose
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/light_wallet/privacy/ title=Privacy class=dd-item>
<a href=/zcash-sync/light_wallet/privacy/>
Privacy
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/light_wallet/utxo/ title="UTXO Model" class=dd-item>
<a href=/zcash-sync/light_wallet/utxo/>
UTXO Model
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/light_wallet/scan/ title="Scan / Sync" class=dd-item>
<a href=/zcash-sync/light_wallet/scan/>
Scan / Sync
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/light_wallet/reorg/ title=Reorganization class=dd-item>
<a href=/zcash-sync/light_wallet/reorg/>
Reorganization
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
</li>
<li data-nav-id=/zcash-sync/data_model/ title="Data Model" class=dd-item>
<a href=/zcash-sync/data_model/><svg class="icon"><use xlink:href="https://hhanh00.github.io/zcash-sync//sprite.svg#db"/></svg>
Data Model
<i class="fas fa-check read-icon"></i>
</a>
<ul>
<li data-nav-id=/zcash-sync/data_model/tables/ title=Tables class=dd-item>
<a href=/zcash-sync/data_model/tables/>
Tables
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/data_model/chunks/ title="Block Chunks" class=dd-item>
<a href=/zcash-sync/data_model/chunks/>
Block Chunks
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/data_model/rollback/ title=Rollback class=dd-item>
<a href=/zcash-sync/data_model/rollback/>
Rollback
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
</li>
<li data-nav-id=/zcash-sync/execution_model/ title="Execution Model" class="dd-item
parent">
<a href=/zcash-sync/execution_model/><svg class="icon"><use xlink:href="https://hhanh00.github.io/zcash-sync//sprite.svg#work"/></svg>
Execution Model
<i class="fas fa-check read-icon"></i>
</a>
<ul>
<li data-nav-id=/zcash-sync/execution_model/tasks/ title=Tasks class="dd-item
parent">
<a href=/zcash-sync/execution_model/tasks/><svg class="icon"><use xlink:href="https://hhanh00.github.io/zcash-sync//sprite.svg#task"/></svg>
Tasks
<i class="fas fa-check read-icon"></i>
</a>
<ul>
<li data-nav-id=/zcash-sync/execution_model/tasks/download/ title=Download class=dd-item>
<a href=/zcash-sync/execution_model/tasks/download/>
Download
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/execution_model/tasks/decrypt/ title=Decrypt class="dd-item active">
<a href=/zcash-sync/execution_model/tasks/decrypt/>
Decrypt
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/execution_model/tasks/witnesses/ title=Witnesses class=dd-item>
<a href=/zcash-sync/execution_model/tasks/witnesses/>
Witnesses
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
</li>
<li data-nav-id=/zcash-sync/execution_model/pipeline/ title=Pipeline class=dd-item>
<a href=/zcash-sync/execution_model/pipeline/>
Pipeline
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/execution_model/agents/ title=Agents class=dd-item>
<a href=/zcash-sync/execution_model/agents/>
Agents
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
</li>
<li data-nav-id=/zcash-sync/api/ title=Interface class=dd-item>
<a href=/zcash-sync/api/><svg class="icon"><use xlink:href="https://hhanh00.github.io/zcash-sync//sprite.svg#api"/></svg>
Interface
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/zcash-sync/example/ title=Example class=dd-item>
<a href=/zcash-sync/example/><svg class="icon"><use xlink:href="https://hhanh00.github.io/zcash-sync//sprite.svg#demo"/></svg>
Example
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
<section id=prefooter>
<hr>
<ul>
<li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li>
</ul>
</section>
<section id=footer>
<p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p>
</section>
</div>
</nav>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
<a href=/zcash-sync/>WarpSync</a> > <a href=/zcash-sync/execution_model/>Execution Model</a> > <a href=/zcash-sync/execution_model/tasks/>Tasks</a> > Decrypt
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#trial-decryption-algorithm>Trial Decryption Algorithm</a></li>
<li><a href=#batch-optimization>Batch optimization</a></li>
<li><a href=#multi-threading>Multi Threading</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Decrypt
</h1>
<p>One of the major tasks in terms of computation is trial decryption.</p>
<p>Every output note (EPK, CIPHERTEXT, CMU) needs to be trial decrypted
with every account Incoming Viewing Key (IVK).</p>
<p>There are currently more than 20 million notes (and it increases).
If you have 2 accounts, it means having to trial decrypt 40 million times.</p>
<p>Typically, one trial decryption takes ~1 ms (the exact time depends on your CPU).
Therefore trial decryption can make up for a substantial portion of the synchronization.</p>
<p>The decryption is performed by the note-encryption crate of <code>librustzcash</code>.</p>
<p>Optionally, on some platform WarpSync can use an alternate hardware accelerated
implementation.</p>
<p>The CIPHERTEXT in the Compact Output <em>only</em> contains the first 52 bytes
of the complete CIPHERTEXT.</p>
<div class="notices info"><p>Compact Outputs exclude the COUT and MEMO parts, therefore it is not possible
to decrypt the memo text or the <em>outgoing</em> notes.</p>
</div>
<p>However, we can identity outgoing transactions by the fact that they
use one of our UTXO.</p>
<h2 id=trial-decryption-algorithm>Trial Decryption Algorithm</h2>
<p>For reference, here is an <em>overview</em> of the algorithm used for decrypting
a compact output using an IVK.</p>
<ul>
<li>The $E$ = EPK, Ephemeral Public Key is a point on the Jubjub curve serialized
in compressed form.</li>
<li>The Diffie-Hellman shared secret is $ S = E^{\text{IVK}}$. Note that the
base point $E$ differs with every note and therefore we cannot optimize
the exponentiation by precomputing tables of powers of $E$.</li>
<li>The decryption key $K$ is the Blake2b hash of $S$.</li>
<li>The ciphertext is encrypted with Chacha20 using $K$.</li>
</ul>
<p>Once again, the CIPHERTEXT in the Compact Output <em>only</em> contains the first 52 bytes
of the complete CIPHERTEXT.</p>
<p>It doesn&rsquo;t have the memo or the authentication digest. We cannot directly
check that the decrypted text is valid. However, the format of a note
restricts the byte values at some offsets. For example, the first byte
is the note version number. It has to be 2 since zip 212 activation.</p>
<p>Furthermore, if by chance the plain note passed all format validation checks
and was still invalid, it would be caught by the CMU check.</p>
<p>We can compute the plain note commitment hash (CMU) and make sure it matches
the CMU from the Compact Output.</p>
<h2 id=batch-optimization>Batch optimization</h2>
<ol>
<li>Getting the affine coordinates (u, v) of EPK involves computing the inverse of a
field element. We can batch multiple inversions together and only have to
calculate one inverse, at the expense of having to do more multiplications.
However, inversions are much more expensive than multiplications so it is still a net
gain.</li>
<li>The point exponentiation is carried out in Extended Coordinates because
then we don&rsquo;t have to do field inversions, and it&rsquo;s faster, but we
have to normalize the result and return to Affine Coordinates. This conversion
uses a field inversion per point. Here again, we can batch these normalizations
and use a single inversion for all the notes of a batch.</li>
</ol>
<h2 id=multi-threading>Multi Threading</h2>
<p>If your CPU has several cores, trial decryption is automatically
performed in parallel. We use <a href=https://docs.rs/rayon/1.5.3/rayon/index.html>Rayon</a>.</p>
<p>Rayon is lightweight and convenient for introducing parallelism into existing code.
It guarantees data-race free executions and takes advantage of parallelism when sensible,
based on work-load at runtime.</p>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
<a class="nav nav-prev" href=/zcash-sync/execution_model/tasks/download/ title=Download> <i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/zcash-sync/execution_model/tasks/witnesses/ title=Witnesses style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/zcash-sync/js/clipboard.min.js?1665316482></script>
<script src=/zcash-sync/js/perfect-scrollbar.min.js?1665316482></script>
<script src=/zcash-sync/js/perfect-scrollbar.jquery.min.js?1665316482></script>
<script src=/zcash-sync/js/jquery.sticky.js?1665316482></script>
<script src=/zcash-sync/js/featherlight.min.js?1665316482></script>
<script src=/zcash-sync/js/highlight.pack.js?1665316482></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/zcash-sync/js/modernizr.custom-3.6.0.js?1665316482></script>
<script src=/zcash-sync/js/learn.js?1665316482></script>
<script src=/zcash-sync/js/hugo-learn.js?1665316482></script>
<script src=/zcash-sync/mermaid/mermaid.js?1665316482></script>
<script>mermaid.initialize({startOnLoad:!0})</script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity=sha384-ljao5I1l+8KYFXG7LNEA7DyaFvuvSCmedUf6Y6JI7LJqiu8q5dEivP2nDdFH31V4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script>
</body>
</html>